name: dist

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - name: fmt
        run: cargo fmt -- --check
      - name: clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: tests (unit + e2e)
        run: |
          cargo test
          cargo test --test install_scripts -- --test-threads=1
          cargo test --test e2e_index_tui -- --test-threads=1
          cargo test --test e2e_install_easy -- --test-threads=1

  dist:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Install cargo-dist
        run: cargo install cargo-dist --locked --root ~/.cargo
      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: dist init
        run: ~/.cargo/bin/dist init --yes --ci github --installer shell --installer powershell
      - name: Build distributions
        env:
          CARGO_TERM_COLOR: always
        run: |
          ~/.cargo/bin/dist build --installer shell --installer powershell
      - name: List dist contents
        run: ls -laR target/dist
      - name: Checksums
        run: |
          cd target/dist
          find . -maxdepth 1 -type f ! -name "*.sha256" -print0 | while IFS= read -r -d '' f; do
            # Strip leading ./ from find output
            filename="${f#./}"
            echo "Hashing $filename ..."
            sha256sum "$filename" > "$filename.sha256" || { echo "Failed to hash $filename"; exit 1; }
          done
      - name: Upload artifacts (workflow)
        uses: actions/upload-artifact@v4
        with:
          name: dist-artifacts
          path: target/dist/**/*
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            target/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
